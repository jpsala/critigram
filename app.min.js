// ==UserScript==
// @name        Criticker
// @namespace   www.criticker.com/*
// @include     http://www.criticker.com/*
/*/ @run-at document-start*/
// @version     1.0
// @updateURL       https://userscripts.org/scripts/source/150793.meta.js
// // @grant       none
// @require file:/D:/firefox.profile/gm_scripts/jquery.min.js
// @require file:/D:/firefox.profile/gm_scripts/jquery.hotkeys.js
// @require file:/D:/firefox.profile/gm_scripts/jquery.contextMenu.js
// 
// ==/UserScript==
/*
 var link = window.document.createElement('link');
 link.rel = 'stylesheet';
 link.type = 'text/css';
 link.href = 'http://localhost/iae/js/jquery.contextMenu.css';
 document.getElementsByTagName("HEAD")[0].appendChild(link);
 */

$(function() {
    var valor = null;
    console.log("ok criticker...");
    getScore();
    $score = $("#fi_scorebox");
    if (valor && $score.length > 0 && $score.is(":visible")) {
        activateScore('fi', '60239', '4712');
        $score.val(valor);
        setTimeout(function() {
            $("#fi_submit_link").click();
        });
    }
    bind();
    if ($("#tl_generatelink").length > 0) {
        var tci = "<button id=\"jptci\" onclick=\"return tci()\">JP TCI!</button>";
        $("#i_forumblog_news_header").append(tci);
    }
    if ($("#ps_generatelink").length > 0) {
        var psi = "<button id=\"jptci\" onclick=\"return psi()\">JP PSII!</button>";
        $("#i_forumblog_news_header").append(psi);
    }
});

input = "jpRank<input id='jpjank' onchange=\"scoreChange($(this))\" style='width:20px'/>";
mas = "<button onclick=\"scoreChange($(this),1)\">+</button>";
menos = "<button onclick=\"scoreChange($(this),-1)\">-</button>";
subir = "<button onclick=\"subePelis()\">Subir</button>";
$("#i_forumblog_news_header").html(input + mas + menos + subir).focus();

$(".fl_filmlist_name").each(function() {
    $peli = $(this);
    id = $peli.find("a").attr("id");
    pos = id.lastIndexOf("_");
    peli_id = id.substr(pos + 1, 10);
    $peli.before("<a onclick='myDeleteScore(" + peli_id + ")' style='cursor:pointer;color:red'>-</a>");
    $peli.before("<a onclick='mySubmitRanking(" + peli_id + ",null,false)' style='cursor:pointer;color:red'>+</a>");
});

createContextMenu();

window.tci = function() {
    tlGenTcis('1386309003_59609');
    tciFunc = setInterval(function() {
        tciFunc = tlGenTcis('1386309003_59609');
    }, 6000);
    var tci = "<button id=\"jpstoptci\" onclick=\"return stopTci()\">Stop TCI!</button>";
    $("#i_forumblog_news_header").append(tci);
    return "ok";
};
window.stopTci = function() {
    window.location.reload();
};
window.psi = function() {
    psGenPsis('1386777473_60239');
    setInterval(function() {
        psiFunc = psGenPsis('1386777473_60239');
    }, 3000);
    var psi = "<button id=\"jpstoppsi\" onclick=\"return stopPsi()\">Stop PSII!</button>";
    $("#i_forumblog_news_header").append(psi);
    return "ok";
};
window.stopPsi = function() {
    window.location.reload();
};

function bind() {
    $es = $("input:visible, body, *");
    $(document).on('keypress', null, 'alt+ctrl+shift+t', function(e) {
        window.open("http://www.criticker.com/?tl");
        return false;
    });
    $(document).on('keypress', null, 'alt+ctrl+shift+p', function(e) {
        window.open("http://www.criticker.com/?ps");
        return false;
    });
    $(document).on('keypress', null, 'alt+ctrl+shift+h', function(e) {
        window.location = "http://www.criticker.com/?fl&view=prs";
        return false;
    });
    $(document).on('keypress', null, 'alt+ctrl+shift+n', function(e) {
        window.open("http://www.criticker.com/?fl&user=juanpsala");
        return false;
    });
    return;
}

function createContextMenu() {
    var menu = document.body.appendChild(document.createElement("menu"));
    var html = document.documentElement;
    if (html.hasAttribute("contextmenu")) {
        // We don't want to override web page context menu if any
        var contextmenu = $("#" + html.getAttribute("contextmenu"));
        contextmenu.appendChild(menu); // Append to web page context menu
    } else {
        html.setAttribute("contextmenu", "mymenu");
    }

    menu.outerHTML = '<menu type="context" id="mymenu">\
            <menuitem label="Borra score"></menuitem>\
            <menu label="Rankear...">\
                <menuitem id="kk1" label="100">hola</menuitem>\
                <menuitem id="kk2" label="95">hola</menuitem>\
                <menuitem id="kk3" label="90">hola</menuitem>\
                <menuitem id="kk4" label="80">hola</menuitem>\
                <menuitem id="kk5" label="70">hola</menuitem>\
                <menuitem id="kk6" label="60">hola</menuitem>\
                <menuitem id="kk7" label="50">hola</menuitem>\
                <menuitem id="kk8" label="40">hola</menuitem>\
                <menuitem id="kk" label="30">hola</menuitem>\
                <menuitem id="kk" label="20">hola</menuitem>\
                <menuitem id="kk" label="10">hola</menuitem>\
                <menuitem id="kk" label="5">hola</menuitem>\
            </menu>\
    </menu>';

    $$("#mymenu").addEventListener("click", menuClick, false);
    html.addEventListener("contextmenu", initMenu, false); // Executed on right clicking
}

function initMenu(e) {
    $peli = $(e.target);
    id = $peli.attr("id");
    pos = id.lastIndexOf("_");
    peli_id = id.substr(pos + 1, 10);
    window.peli_id = peli_id;
}

function menuClick(e) {
    menu = e.explicitOriginalTarget.label;
    if (menu === "Borra score") {
        console.log("borrando...");
        myDeleteScore(window.peli_id);
    } else if ($.isNumeric(menu)) {
        mySubmitRanking(window.peli_id, Number(menu));
    }
    return;
}

function $$(aSelector, aNode) {
    return (aNode || document).querySelector(aSelector);
}

window.mySubmitRanking = function(filmid, score, refresh) {
    if (!score) {
        score = $("#jpjank").val();
    }
    refresh = refresh ? refresh : false;
    if (!DHTML)
        return;

    if (isWorking) {
        alert('Please wait until PSIs are Regenerated');
        return;
    }

    var submitRankingUrl = "ajax/submitRanking.php";

    if (!score) {
        alert("primero ingrese el ranking");
        return false;
    }
    var quote = "";

    if (http) {
        fullSubmitRankingUrl = submitRankingUrl + '?f=' + escape(filmid) + '&s=' + escape(score);
        if (quote) {
            fullSubmitRankingUrl = fullSubmitRankingUrl + '&q=' + escape(quote);
        }

        http.open("GET", fullSubmitRankingUrl, true);
        http.onreadystatechange = function() {
            if (http.readyState == 4) {
                if (http.responseText.indexOf('criticker_xxx_invalid') == -1) {
                    $("#fl_filmlist_score_" + filmid).find("span").html(score);
                    $("#fl_filmlist_score_" + filmid).closest("div").addClass("fl_filmlist_film_seen");
                    if (refresh) {
                        window.location.reload();
                    }
                    isWorking = false;
                    subePelis(filmid);
                }
            }
        };

        http.send(null);
//        isWorking = true;
    }
};

window.myDeleteScore = function(filmid) {
    var deleteUrl = webDir + "ajax/deleteRanking.php";

    /* Ask them to confirm their desire to delete ranking */
    if (http3) {
        fullDeleteUrl = deleteUrl + '?filmid=' + escape(filmid);
        http3.open("GET", fullDeleteUrl, true);

        // We put this inside to enable multiple simultaneous calls
        http3.onreadystatechange = function() {
            if (http3.readyState == 4) {
                $("#fl_filmlist_film_" + filmid).remove();
            }
        };

        http3.send(null);
        //isWorking = true;
        subePelis(filmid, true);
        isWorking = false;

    }

}

window.setScore = function(score) {
    $.ajax({
        type: "GET",
        dataType: "jsonp",
        data: {"score": score},
        url: "http://localhost/iae/index.php?r=criticker/setScore",
        crossDomain: true,
        success: function(data) {
            console.log(data);
        },
        error: function(data, status) {
            console.log(data, status);
        }
    });
    return "ok";
};

window.getScore = function() {
    $.ajax({
        type: "GET",
        dataType: "jsonp",
        url: "http://localhost/iae/index.php?r=criticker/getScore",
        crossDomain: true,
        success: function(data) {
            $("#jpjank").val(data.score);
        },
        error: function(data, status) {
            console.log(data, status);
        }
    });
    return "ok";
};

window.scoreChange = function($this, plus) {
    plus = plus ? plus : 0;
    score = Number($("#jpjank").val()) + Number(plus);
    $("#jpjank").val(score);
    setScore(score);
};

window.subePelis = function(peli_id, borra) {
    var user = $(".fl_filter_header").html();
    var login = $("#i_username_link").html();
    var cantPosts = 0;
    var total = 0;
    var posts = [];
    borra = borra ? 1 : 0;
    if (user === "Your Rankings" || user === "Film Database") {
        user = login;
    }
    if (!user) {
        alert("falta usuario");
        return "mal";
    } else if (!login) {
        alert("falta login");
        return "mal";
    }
    var post = "&user=" + user + "&login=" + login;
    if (peli_id) {
        $pelis = $("#fl_filmlist_link_" + peli_id).parent();
    } else {
        $pelis = $(".fl_filmlist_name");
    }
    $pelis.each(function() {
        total++;
        $peli = $(this);
        id = $peli.find("a").attr("id");
        pos = id.lastIndexOf("_");
        peli_id = id.substr(pos + 1, 10);
        nombre = $peli.find("a").html();
        score = $("#fl_filmlist_score_" + peli_id).find("span").html();
        post += "&peli[" + peli_id + "][nombre]=" + nombre + "&peli[" + peli_id + "][score]=" + score + "&peli[" + peli_id + "][borra]=" + borra;
        if (cantPosts++ === 20) {
            cantPosts = 0;
            posts.push(post);
            post = "&user=" + user + "&login=" + login;
        }
    });
    if (cantPosts > 0) {
        posts.push(post);
    }
    postPelis(posts);
    return total;
};

window.postPelis = function(posts) {
    post = posts.pop();
    $.ajax({
        type: "GET",
        dataType: "jsonp",
        data: post,
        url: "http://localhost/iae/index.php?r=criticker/pelis",
        crossDomain: true,
        success: function(data) {
            if (posts.length > 0) {
                postPelis(posts);
            }
            console.log(data);
        },
        error: function(data, status, c) {
            console.log(data, status, c);
        }
    });
};

window.getPelis = function() {
    $.ajax({
        type: "GET",
        dataType: "jsonp",
        url: "http://localhost/iae/index.php?r=criticker/getPelis",
        crossDomain: true,
        success: function(data) {
            console.log(data);
        },
        error: function(data, status) {
            console.log(data, status);
        }
    });
    return "ok";
};


(function() {
    var calc, graph, last_data, last_width, re;
    google.load("visualization", "1", {packages: ["corechart"]});
    re = RegExp(/^\d+/gm);
    last_data = null;
    last_width = null;
    calc = function() {
        var data, ratings, ratings_raw;
        data = document.getElementById("data").value;
        if (data === last_data && last_width === window.innerWidth) {
            return
        }
        last_data = data;
        last_width = window.innerWidth;
        ratings_raw = data.match(re);
        if (ratings_raw != null) {
            ratings = _.map(ratings_raw, function(v) {
                return parseInt(v)
            })
        } else {
            ratings = []
        }
        return graph(ratings)
    };
    graph = function(rankings) {
        var chart, data, labels, merge, options, values, x;
        labels = function() {
            var _i, _results;
            _results = [];
            for (x = _i = 10; _i <= 100; x = _i += 10) {
                _results.push("" + (x - (x > 10 ? 9 : 10)) + "-" + x)
            }
            return _results
        }();
        values = Array.apply(null, new Array(10)).map(Number.prototype.valueOf, 0);
        _.each(rankings, function(v) {
            var b;
            b = v > 0 ? Math.floor((v - 1) / 1) : 0;
            return values[b] += 1
        });
        merge = _.zip(labels, values);
        merge.unshift(["Ranking", "Count"]);
        data = google.visualization.arrayToDataTable(merge);
        options = {hAxis: {title: "Rating range"}, vAxis: {title: "Number of ratings"}, legend: {position: "none"}};
        chart = new google.visualization.ColumnChart(document.getElementById("graph"));
        return chart.draw(data, options)
    };
    setInterval(calc, 1e3)
}).call(this);
